<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hero Stats Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1c1f26;
      color: #f0f0f0;
    }
    header {
      padding: 20px;
      text-align: center;
      background: #262a33;
    }
    .filters {
      text-align: center;
      margin: 20px 0;
    }
    select {
      margin: 0 10px;
      padding: 5px 10px;
    }
    .columns {
      display: flex;
      justify-content: space-around;
      padding: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }
    .column {
      background: #2f3442;
      border-radius: 8px;
      padding: 15px;
      flex: 1;
      min-width: 300px;
      max-width: 400px;
    }
    .column h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #ffc107;
    }
    .hero-card {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 10px 0;
      background: #1f222e;
      padding: 8px;
      border-radius: 8px;
    }
    .hero-card img {
      width: 40px;
      height: 40px;
      border-radius: 5px;
    }
    .bar {
      height: 6px;
      background: red;
      border-radius: 4px;
      margin-top: 2px;
    }
    .hero-info small {
      font-size: 0.85rem;
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hero Stats Overview</h1>
  </header>

  <div class="filters">
    <label for="tournamentSelect">Tournament:</label>
    <select id="tournamentSelect"><option value="all">All</option></select>

    <label for="teamSelect">Team:</label>
    <select id="teamSelect"><option value="all">All</option></select>
  </div>

  <div class="columns">
    <div class="column" id="pickColumn"><h2>Most Picked</h2></div>
    <div class="column" id="banColumn"><h2>Most Banned</h2></div>
    <div class="column" id="winColumn"><h2>Highest Win Rate</h2></div>
  </div>

<script>
const heroAPI = "https://neptuneg1.github.io/hok-caster/data.json";
const matchAPI = "https://neptuneg1.github.io/hok-caster/matchdata.json";
let heroList = [], matchList = [];

function getHeroImage(name) {
  const hero = heroList.find(h => h.Hero.toLowerCase() === name.toLowerCase());
  return hero?.ImageURL || 'https://i.imgur.com/kkUX3a3.jpeg';
}

function getFilteredMatches() {
  const tournament = document.getElementById('tournamentSelect').value;
  const team = document.getElementById('teamSelect').value;
  return matchList.filter(m =>
    (tournament === 'all' || m.tournament === tournament) &&
    (team === 'all' || m.team1_name === team || m.team2_name === team)
  );
}

function computeHeroStats(matches) {
  const stats = {};
  matches.forEach(match => {
    const picks = [...Array(5).keys()].flatMap(i => [match[`team1_hero${i+1}`], match[`team2_hero${i+1}`]]);
    const bans = [...Array(4).keys()].flatMap(i => [match[`team1_ban${i+1}`], match[`team2_ban${i+1}`]]);
    const winners = match.winner === match.team1_name
      ? [...Array(5).keys()].map(i => match[`team1_hero${i+1}`])
      : [...Array(5).keys()].map(i => match[`team2_hero${i+1}`]);

    picks.forEach(h => {
      if (!stats[h]) stats[h] = { picks: 0, bans: 0, wins: 0 };
      stats[h].picks++;
    });

    bans.forEach(h => {
      if (!stats[h]) stats[h] = { picks: 0, bans: 0, wins: 0 };
      stats[h].bans++;
    });

    winners.forEach(h => {
      if (!stats[h]) stats[h] = { picks: 0, bans: 0, wins: 0 };
      stats[h].wins++;
    });
  });

  return stats;
}

function renderStats() {
  const matches = getFilteredMatches();
  const stats = computeHeroStats(matches);
  const total = matches.length;

  const sortedPicks = Object.entries(stats)
    .filter(([_, v]) => v.picks > 0)
    .map(([hero, v]) => ({ hero, img: getHeroImage(hero), rate: v.picks / total, value: v.picks }))
    .sort((a, b) => b.rate - a.rate)
    .slice(0, 20);

  const sortedBans = Object.entries(stats)
    .filter(([_, v]) => v.bans > 0)
    .map(([hero, v]) => ({ hero, img: getHeroImage(hero), rate: v.bans / total, value: v.bans }))
    .sort((a, b) => b.rate - a.rate)
    .slice(0, 20);

  const sortedWins = Object.entries(stats)
    .filter(([_, v]) => v.picks >= 3) // only show heroes with at least 3 picks
    .map(([hero, v]) => ({ hero, img: getHeroImage(hero), rate: v.wins / v.picks, value: `${v.wins}/${v.picks}` }))
    .sort((a, b) => b.rate - a.rate)
    .slice(0, 20);

  renderColumn("pickColumn", "Pick", sortedPicks);
  renderColumn("banColumn", "Ban", sortedBans);
  renderColumn("winColumn", "Win", sortedWins);
}

function renderColumn(id, label, data) {
  const col = document.getElementById(id);
  col.innerHTML = `<h2>Most ${label}ed</h2>` + data.map(d => `
    <div class="hero-card">
      <img src="${d.img}" alt="${d.hero}">
      <div class="hero-info">
        <small><strong>${d.hero}</strong></small>
        <small style="color:${label === 'Win' ? '#2196f3' : label === 'Ban' ? '#f44336' : '#4caf50'}">
          ${label}: ${(d.rate * 100).toFixed(1)}% (${d.value})
        </small>
        <div class="bar" style="width:${(d.rate * 100).toFixed(1)}%; background: ${
          label === 'Win' ? '#2196f3' : label === 'Ban' ? '#f44336' : '#4caf50'
        }"></div>
      </div>
    </div>`).join('');
}

async function fetchData() {
  const [heroRes, matchRes] = await Promise.all([fetch(heroAPI), fetch(matchAPI)]);
  heroList = await heroRes.json();
  matchList = await matchRes.json();
  matchList.reverse();

  const tournaments = [...new Set(matchList.map(m => m.tournament))].sort();
  const teams = [...new Set(matchList.flatMap(m => [m.team1_name, m.team2_name]))].sort();

  tournaments.forEach(t => {
    document.getElementById('tournamentSelect').innerHTML += `<option value="${t}">${t}</option>`;
  });

  teams.forEach(t => {
    document.getElementById('teamSelect').innerHTML += `<option value="${t}">${t}</option>`;
  });

  document.getElementById('tournamentSelect').addEventListener('change', renderStats);
  document.getElementById('teamSelect').addEventListener('change', renderStats);

  renderStats();
}

fetchData();
</script>
</body>
</html>
